# URL Checker

## Обзор проекта

URL Checker - это приложение для мониторинга доступности веб-сайтов. Оно периодически проверяет указанный URL и отправляет уведомления в Telegram, если сайт недоступен или возвращает ошибку.

### Основные возможности:

- Периодическая проверка доступности URL
- Логирование результатов проверок
- Отправка уведомлений в Telegram при обнаружении проблем
- Автоматический повтор запросов при временных ошибках
- Контейнеризация с помощью Docker

## Установка и настройка

### Предварительные требования

- Python 3.11 или выше
- Docker и Docker Compose (для запуска в контейнере)
- Токен бота Telegram и ID чата (для уведомлений)

### Установка без Docker

1. Клонируйте репозиторий:
   ```bash
   git clone <url-репозитория>
   cd url-checker
   ```

2. Используйте скрипт для автоматической настройки и запуска:
   ```bash
   chmod +x run_local.sh
   ./run_local.sh
   ```
   
   Скрипт выполнит следующие действия:
   - Создаст файл `.env` из примера (если его нет)
   - Создаст виртуальное окружение Python
   - Установит зависимости
   - Запустит приложение

   Или выполните шаги вручную:

   ```bash
   # Установка зависимостей
   pip install -r requirements.txt
   
   # Создание файла .env из примера
   cp .env.example .env
   
   # Редактирование .env (укажите свои значения)
   nano .env
   
   # Запуск приложения
   python main.py
   ```

### Установка с Docker

1. Клонируйте репозиторий:
   ```bash
   git clone <url-репозитория>
   cd url-checker
   ```

2. Используйте скрипт для автоматической настройки и запуска:
   ```bash
   chmod +x docker_test.sh
   ./docker_test.sh
   ```
   
   Скрипт выполнит следующие действия:
   - Создаст файл `.env` из примера (если его нет)
   - Соберет Docker-образ
   - Запустит контейнер
   - Покажет логи контейнера

   Или выполните шаги вручную:

   ```bash
   # Создание файла .env из примера
   cp .env.example .env
   
   # Редактирование .env (укажите свои значения)
   nano .env
   
   # Сборка и запуск контейнера
   docker compose up -d
   ```

## Конфигурация

Приложение настраивается через переменные окружения:

| Переменная | Описание | Значение по умолчанию |
|------------|----------|------------------------|
| URL_TO_CHECK | URL для проверки | Обязательный параметр |
| INTERVAL_SECONDS | Интервал между проверками (в секундах) | 60 |
| TELEGRAM_BOT_TOKEN | Токен бота Telegram для отправки уведомлений | Опционально |
| TELEGRAM_CHAT_ID | ID чата Telegram для отправки уведомлений | Опционально |

### Создание бота Telegram

Для получения уведомлений в Telegram:

1. Создайте бота через [@BotFather](https://t.me/BotFather) и получите токен
2. Найдите свой ID чата, отправив сообщение боту [@userinfobot](https://t.me/userinfobot)
3. Добавьте полученные значения в переменные окружения

## Использование

После запуска приложение будет автоматически проверять указанный URL с заданным интервалом. Результаты проверок записываются в лог-файл `logs/app.log` и выводятся в консоль.

При обнаружении проблем (недоступность сайта, ошибки HTTP) приложение отправляет уведомления в Telegram (если настроено).

### Логи

Логи сохраняются в директории `logs/app.log` с ротацией (максимальный размер файла 5 МБ, хранятся 3 последних файла).

Пример записи в логе:
```
2025-04-08 13:00:00 - INFO - Начинаем проверку URL: https://example.com каждые 60 секунд
2025-04-08 13:00:01 - INFO - Успешный запрос: статус 200 от https://example.com
2025-04-08 13:01:01 - ERROR - Ошибка: получен статус-код 500 от https://example.com
```

## Docker-развертывание

### Локальное развертывание

Для запуска приложения в Docker:

```bash
docker compose up -d
```

Для остановки:

```bash
docker compose down
```

### Проверка состояния

```bash
docker compose ps
docker compose logs
```

### Развертывание на сервере

Для развертывания на сервере используйте скрипт `deploy.sh`:

1. Скопируйте файлы проекта на сервер
2. Настройте переменные окружения в файле `.env`
3. Сделайте скрипт исполняемым:
   ```bash
   chmod +x deploy.sh
   ```
4. Запустите скрипт:
   ```bash
   ./deploy.sh
   ```

### Развертывание в Docker Swarm

Для развертывания приложения в кластере Docker Swarm используйте скрипт `swarm_deploy.sh`:

1. Убедитесь, что Docker запущен в режиме Swarm (или скрипт инициализирует его автоматически)
2. Настройте переменные окружения в файле `.env`
3. Сделайте скрипт исполняемым:
   ```bash
   chmod +x swarm_deploy.sh
   ```
4. Запустите скрипт:
   ```bash
   ./swarm_deploy.sh
   ```

Скрипт поддерживает следующие опции:
```
--stack-name NAME    Имя стека (по умолчанию: url-checker)
--registry URL       URL Docker-реестра (по умолчанию: localhost)
--tag TAG            Тег образа (по умолчанию: latest)
--replicas N         Количество реплик (по умолчанию: 1)
```

Пример использования с внешним реестром и несколькими репликами:
```bash
./swarm_deploy.sh --registry registry.example.com --replicas 3
```

Управление развернутым стеком:
```bash
# Просмотр сервисов
docker service ls

# Просмотр логов
docker service logs url-checker_url-checker

# Масштабирование сервиса
docker service scale url-checker_url-checker=5

# Удаление стека
docker stack rm url-checker
```

### Обновление приложения

Для обновления приложения из репозитория используйте скрипт `update.sh`:

```bash
chmod +x update.sh
./update.sh
```

Скрипт выполнит следующие действия:
- Сохранит локальные изменения
- Получит последние изменения из репозитория
- Восстановит локальные изменения
- Обновит Docker-образ (если Docker установлен)
- Перезапустит контейнер (если он был запущен)

## Мониторинг и логирование

### Просмотр логов

Для просмотра логов контейнера:

```bash
docker compose logs -f
```

### Проверка работоспособности

Docker Compose настроен с проверкой работоспособности (healthcheck), которая периодически проверяет доступность указанного URL.

## Устранение неполадок

### Распространенные проблемы

1. **Приложение не отправляет уведомления в Telegram**
   - Проверьте, что переменные `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID` заданы корректно
   - Убедитесь, что бот имеет доступ к указанному чату

2. **Ошибки при запуске контейнера**
   - Проверьте логи: `docker compose logs`
   - Убедитесь, что переменная `URL_TO_CHECK` задана

3. **Проблемы с доступом к логам**
   - Логи хранятся внутри контейнера в директории `/app/logs`
   - Для постоянного хранения логов можно добавить volume в `docker-compose.yml`

### Добавление постоянного хранения логов

Для сохранения логов вне контейнера добавьте в `docker-compose.yml`:

```yaml
services:
  url-checker:
    # ... существующая конфигурация ...
    volumes:
      - ./logs:/app/logs
```

## Архитектура приложения

Приложение состоит из следующих компонентов:

1. **Основной модуль** (`main.py`):
   - Настройка логирования
   - Функция отправки уведомлений в Telegram
   - HTTP-сессия с автоматическими повторами
   - Основной цикл проверки URL

2. **Docker-контейнеризация**:
   - Dockerfile для создания образа
   - Docker Compose для управления контейнером и переменными окружения

3. **Скрипт развертывания** (`deploy.sh`):
   - Автоматизация процесса обновления и перезапуска на сервере
